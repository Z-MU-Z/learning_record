# GLIP



代码理解

GLIP/MODEL/glip_tiny_model_o365_goldg.pth



## 命令

```
hfai python tools/test_grounding_net.py --config-file /ceph-jd/pub/jupyter/zhumuzhi/notebooks/GLIP/configs/pretrain/glip_Swin_T_O365_GoldG.yaml --weight ./MODEL/glip_tiny_model_o365_goldg.pth \
        TEST.IMS_PER_BATCH 3 \
        MODEL.DYHEAD.SCORE_AGG "MEAN" \
        TEST.EVAL_TASK detection \
        MODEL.DYHEAD.FUSE_CONFIG.MLM_LOSS False \
        OUTPUT_DIR ./output3 \
        -- --nodes 1 --priority 10
```

hfai logs -f tools/test_grounding_net.py 

hfai stop tools/test_grounding_net.py 

```py
python
from transformers import AutoTokenizer
AutoTokenizer.from_pretrained(cfg.MODEL.LANGUAGE_BACKBONE.TOKENIZER_TYPE)
```

## config	

[2022-04-20 23:17:28.136117]   BRIGHTNESS: 0.0
[2022-04-20 23:17:28.136130]   CONTRAST: 0.0
[2022-04-20 23:17:28.136148]   CROP_MIN_IOUS: (0.1, 0.3, 0.5, 0.7, 0.9)
[2022-04-20 23:17:28.136164]   CROP_MIN_SIZE: 0.3
[2022-04-20 23:17:28.136182]   CROP_PROB: 0.5
[2022-04-20 23:17:28.136199]   FLIP_PROB_TRAIN: 0.5
[2022-04-20 23:17:28.136216]   HUE: 0.0
[2022-04-20 23:17:28.136233]   MULT_MIN_SIZE_TRAIN: (480, 560, 640, 720, 800)
[2022-04-20 23:17:28.136244]   SATURATION: 0.0
[2022-04-20 23:17:28.136254]   USE_RA: 0
[2022-04-20 23:17:28.136264]   VERTICAL_FLIP_PROB_TRAIN: 0.0
[2022-04-20 23:17:28.136274] DATALOADER:
[2022-04-20 23:17:28.136284]   ASPECT_RATIO_GROUPING: True
[2022-04-20 23:17:28.136294]   DISTRIBUTE_CHUNK_AMONG_NODE: False
[2022-04-20 23:17:28.136305]   MIN_KPS_PER_IMS: 0
[2022-04-20 23:17:28.136370]   NUM_WORKERS: 4
[2022-04-20 23:17:28.136392]   SIZE_DIVISIBILITY: 32
[2022-04-20 23:17:28.136409]   USE_RANDOM_SEED: False
[2022-04-20 23:17:28.136441] DATASETS:
[2022-04-20 23:17:28.136462]   ADD_DET_PROMPT: False
[2022-04-20 23:17:28.136482]   ADD_DET_PROMPT_ADVANCED: False
[2022-04-20 23:17:28.136501]   ALTERNATIVE_TRAINING: False
[2022-04-20 23:17:28.136519]   BING_INDEX_LIST: []
[2022-04-20 23:17:28.136539]   BOX_THRESHOLD: 0.1
[2022-04-20 23:17:28.136557]   CAPTION_CONF: 0.9
[2022-04-20 23:17:28.136576]   CAPTION_FORMAT_VERSION: v1
[2022-04-20 23:17:28.136589]   CAPTION_MIN_BOX: 1
[2022-04-20 23:17:28.136603]   CAPTION_NMS: 0.9
[2022-04-20 23:17:28.136615]   CAPTION_PROMPT: None
[2022-04-20 23:17:28.136629]   CLASS_AGNOSTIC: False
[2022-04-20 23:17:28.136641]   CLASS_CONCAT: False
[2022-04-20 23:17:28.136656]   COCO_COPY: 1
[2022-04-20 23:17:28.136666]   CONTROL_PROB: (0.0, 0.0, 0.5, 0.0)
[2022-04-20 23:17:28.136681]   DISABLE_CLIP_TO_IMAGE: False
[2022-04-20 23:17:28.136694]   DISABLE_SHUFFLE: False
[2022-04-20 23:17:28.136704]   DIVER_BOX_FOR_VQA: False
[2022-04-20 23:17:28.136716]   FEW_SHOT: 0
[2022-04-20 23:17:28.136730]   FLICKR_COPY: 1
[2022-04-20 23:17:28.136742]   FLICKR_GT_TYPE: separate
[2022-04-20 23:17:28.136755]   FULL_QUESTION_PROB: 0.5
[2022-04-20 23:17:28.136769]   FURTHER_SCREEN: False
[2022-04-20 23:17:28.136782]   GENERAL_COPY: -1
[2022-04-20 23:17:28.136795]   GENERAL_COPY_TEST: -1
[2022-04-20 23:17:28.136809]   INFERENCE_CAPTION: False
[2022-04-20 23:17:28.136822]   IN_COPY: 1
[2022-04-20 23:17:28.136834]   LOCAL_DEBUG: False
[2022-04-20 23:17:28.136847]   LVIS_COPY: 1
[2022-04-20 23:17:28.136861]   LVIS_USE_NORMAL_AP: False
[2022-04-20 23:17:28.136874]   MAX_BOX: -1
[2022-04-20 23:17:28.136887]   MIXED_COPY: 1
[2022-04-20 23:17:28.136900]   MULTISTAGE_TRAINING: False
[2022-04-20 23:17:28.136914]   NEG_QUESTION_PROB: 0.8
[2022-04-20 23:17:28.136926]   NO_MINUS_ONE_FOR_ONE_HOT: False
[2022-04-20 23:17:28.136939]   NO_RANDOM_PACK_PROBABILITY: 0.0
[2022-04-20 23:17:28.136951]   OBJECT365_COPY: 1
[2022-04-20 23:17:28.136983]   OI_COPY: 1
[2022-04-20 23:17:28.136999]   ONE_HOT: False
[2022-04-20 23:17:28.137009]   OVERRIDE_CATEGORY: None
[2022-04-20 23:17:28.137019]   PACK_RANDOM_CAPTION_NUMBER: 0
[2022-04-20 23:17:28.137034]   POS_QUESTION_PROB: 0.6
[2022-04-20 23:17:28.137049]   PREDEFINED_TEXT: None
[2022-04-20 23:17:28.137062]   PROMPT_LIMIT_NEG: -1
[2022-04-20 23:17:28.137076]   PROMPT_VERSION: 
[2022-04-20 23:17:28.137088]   RANDOM_PACK_PROB: -1.0
[2022-04-20 23:17:28.137102]   RANDOM_SAMPLE_NEG: 85
[2022-04-20 23:17:28.137114]   REGISTER:
[2022-04-20 23:17:28.137127]     
[2022-04-20 23:17:28.137140]   REPLACE_CLEAN_LABEL: False
[2022-04-20 23:17:28.137154]   SAFEGUARD_POSITIVE_CAPTION: True
[2022-04-20 23:17:28.137169]   SAMPLE_NEGATIVE_FOR_GROUNDING_DATA: -1.0
[2022-04-20 23:17:28.137184]   SAMPLE_RATIO: 0.0
[2022-04-20 23:17:28.137198]   SEPARATION_TOKENS: . 
[2022-04-20 23:17:28.137214]   SHUFFLE_SEED: 0
[2022-04-20 23:17:28.137228]   SPECIAL_SAFEGUARD_FOR_COCO_GROUNDING: False
[2022-04-20 23:17:28.137242]   SUPRESS_QUERY: None
[2022-04-20 23:17:28.137254]   TEST: ('coco_2017_val',)
[2022-04-20 23:17:28.137269]   TEST_DATASETNAME_SUFFIX: 
[2022-04-20 23:17:28.137286]   TRAIN: ('object365_dt_train', 'mixed_train_no_coco', 'flickr30k_train')
[2022-04-20 23:17:28.137302]   TRAIN_DATASETNAME_SUFFIX: 
[2022-04-20 23:17:28.137318]   USE_CAPTION_PROMPT: False
[2022-04-20 23:17:28.137331]   USE_COCO_FORMAT: False
[2022-04-20 23:17:28.137347]   USE_CROWD: False
[2022-04-20 23:17:28.137362]   USE_OD_AUG: False
[2022-04-20 23:17:28.137374]   USE_OVERRIDE_CATEGORY: False
[2022-04-20 23:17:28.137384]   USE_SUPRESS_QUERY: False
[2022-04-20 23:17:28.137402]   VG_COPY: 1
[2022-04-20 23:17:28.137417] INPUT:
[2022-04-20 23:17:28.137432]   FIX_RES: False
[2022-04-20 23:17:28.137448]   FORMAT: 
[2022-04-20 23:17:28.137463]   MAX_SIZE_TEST: 1333
[2022-04-20 23:17:28.137479]   MAX_SIZE_TRAIN: 1333
[2022-04-20 23:17:28.137494]   MIN_SIZE_TEST: 800
[2022-04-20 23:17:28.137509]   MIN_SIZE_TRAIN: 800
[2022-04-20 23:17:28.137524]   PIXEL_MEAN: [103.53, 116.28, 123.675]
[2022-04-20 23:17:28.137540]   PIXEL_STD: [57.375, 57.12, 58.395]
[2022-04-20 23:17:28.137556]   TO_BGR255: True
[2022-04-20 23:17:28.137572] MODEL:
[2022-04-20 23:17:28.137586]   ATSS:
[2022-04-20 23:17:28.137601]     CHANNELS: 128
[2022-04-20 23:17:28.137617]     DETECTIONS_PER_IMG: 100
[2022-04-20 23:17:28.137631]     INFERENCE_TH: 0.05
[2022-04-20 23:17:28.137646]     INFERENCE_TH_TRAIN: 0.0
[2022-04-20 23:17:28.137661]     NMS_TH: 0.6
[2022-04-20 23:17:28.137675]     NUM_CLASSES: 81
[2022-04-20 23:17:28.137691]     NUM_CONVS: 4
[2022-04-20 23:17:28.137717]     POST_NMS_TOP_N_TRAIN: 1000
[2022-04-20 23:17:28.137729]     PRE_NMS_TOP_N: 1000
[2022-04-20 23:17:28.137740]     PRE_NMS_TOP_N_TRAIN: 3000
[2022-04-20 23:17:28.137749]     PRIOR_PROB: 0.01
[2022-04-20 23:17:28.137766]     REG_LOSS_WEIGHT: 2.0
[2022-04-20 23:17:28.137782]     TOPK: 9
[2022-04-20 23:17:28.137797]     USE_BN: False
[2022-04-20 23:17:28.137811]     USE_DFCONV: False
[2022-04-20 23:17:28.137823]     USE_DYRELU: False
[2022-04-20 23:17:28.137837]     USE_GN: False
[2022-04-20 23:17:28.137851]     USE_SE: False
[2022-04-20 23:17:28.137865]   BACKBONE:
[2022-04-20 23:17:28.137880]     CONV_BODY: SWINT-FPN-RETINANET
[2022-04-20 23:17:28.137892]     EFFICIENT_DET_BIFPN_VERSION: 0
[2022-04-20 23:17:28.137906]     EFFICIENT_DET_COMPOUND: 0
[2022-04-20 23:17:28.137918]     EFFICIENT_DET_START_FROM: 3
[2022-04-20 23:17:28.137932]     FPN_LAYER: ()
[2022-04-20 23:17:28.137946]     FREEZE: False
[2022-04-20 23:17:28.137959]     FREEZE_CONV_BODY_AT: -1
[2022-04-20 23:17:28.137973]     GROUP: 1
[2022-04-20 23:17:28.137985]     LAYER_SEARCH:
[2022-04-20 23:17:28.137999]       
[2022-04-20 23:17:28.138014]     LAYER_SETUP: (3, 4, 6, 3)
[2022-04-20 23:17:28.138027]     NORM_LEVEL: 3
[2022-04-20 23:17:28.138041]     OUT_CHANNELS: 256
[2022-04-20 23:17:28.138054]     OUT_FEATURES: ('stage2', 'stage3', 'stage4', 'stage5')
[2022-04-20 23:17:28.138068]     RESET_BN: False
[2022-04-20 23:17:28.138082]     USE_BN: False
[2022-04-20 23:17:28.138095]     USE_CHECKPOINT: False
[2022-04-20 23:17:28.138108]     USE_DFCONV: False
[2022-04-20 23:17:28.138122]     USE_DYRELU: False
[2022-04-20 23:17:28.138135]     USE_EN: False
[2022-04-20 23:17:28.138149]     USE_GN: False
[2022-04-20 23:17:28.138161]     USE_NSYNCBN: False
[2022-04-20 23:17:28.138175]     USE_SE: False
[2022-04-20 23:17:28.138189]     USE_SYNCBN: False
[2022-04-20 23:17:28.138201]   BIFPN:
[2022-04-20 23:17:28.138216]     NUM_REPEATS: 1
[2022-04-20 23:17:28.138232]     USE_ATTENTION: True
[2022-04-20 23:17:28.138247]   BOX_ON: True
[2022-04-20 23:17:28.138258]   CLIP:
[2022-04-20 23:17:28.138271]     CONTEXT_LENGTH: 256
[2022-04-20 23:17:28.138286]     DROP_PATH: 0.0
[2022-04-20 23:17:28.138298]     HEADS: 8
[2022-04-20 23:17:28.138314]     LAYERS: 12
[2022-04-20 23:17:28.138330]     TOKENIZER: clip
[2022-04-20 23:17:28.138343]     VOCAB_SIZE: 49408
[2022-04-20 23:17:28.138357]     WIDTH: 512
[2022-04-20 23:17:28.138369]   DEBUG: False
[2022-04-20 23:17:28.138383]   DEVICE: cuda
[2022-04-20 23:17:28.138398]   DYHEAD:
[2022-04-20 23:17:28.138412]     CHANNELS: 256
[2022-04-20 23:17:28.138425]     CONV_FUNC: 
[2022-04-20 23:17:28.138439]     COSINE_SCALE: -1.0
[2022-04-20 23:17:28.138453]     FUSE_CONFIG:
[2022-04-20 23:17:28.138466]       ADD_LINEAR_LAYER: False
[2022-04-20 23:17:28.138479]       CLAMP_BERTATTN_MAX_FOR_OVERFLOW: True
[2022-04-20 23:17:28.138494]       CLAMP_BERTATTN_MIN_FOR_UNDERFLOW: True
[2022-04-20 23:17:28.138507]       CLAMP_DOT_PRODUCT: True
[2022-04-20 23:17:28.138520]       CLAMP_MAX_FOR_OVERFLOW: True
[2022-04-20 23:17:28.138530]       CLAMP_MIN_FOR_UNDERFLOW: True
[2022-04-20 23:17:28.138544]       CONTRASTIVE_ALIGN_LOSS_WEIGHT: 1.0
[2022-04-20 23:17:28.138558]       CONTRASTIVE_HIDDEN_DIM: 64
[2022-04-20 23:17:28.138570]       DOT_PRODUCT_TOKEN_LOSS_WEIGHT: 1.0
[2022-04-20 23:17:28.138584]       DO_LANG_PROJ_OUTSIDE_CHECKPOINT: False
[2022-04-20 23:17:28.138597]       EARLY_FUSE_ON: True
[2022-04-20 23:17:28.138610]       JOINT_EMB_DROPOUT: 0.1
[2022-04-20 23:17:28.138624]       JOINT_EMB_SIZE: 256
[2022-04-20 23:17:28.138637]       JOINT_MLP_LAYERS: 2
[2022-04-20 23:17:28.138651]       JOINT_OUT_SIZE: 256
[2022-04-20 23:17:28.138663]       MLM_LOSS: False
[2022-04-20 23:17:28.138677]       MLM_LOSS_COEF: 1.0
[2022-04-20 23:17:28.138690]       MLM_LOSS_FOR_ONLY_POSITIVES: True
[2022-04-20 23:17:28.138704]       MLM_OBJ_FOR_ONLY_POSITIVE: False
[2022-04-20 23:17:28.138716]       NO_MASK_FOR_GOLD: False
[2022-04-20 23:17:28.138730]       NO_MASK_FOR_OD: False
[2022-04-20 23:17:28.138744]       SEPARATE_BIDIRECTIONAL: False
[2022-04-20 23:17:28.138757]       SHALLOW_CONTRASTIVE_HIDDEN_DIM: 64
[2022-04-20 23:17:28.138770]       SHALLOW_CONTRASTIVE_LOSS_WEIGHT: 1.0
[2022-04-20 23:17:28.138785]       SHALLOW_MAX_POSITIVE_ANCHORS: 100
[2022-04-20 23:17:28.138797]       STABLE_SOFTMAX_2D: False
[2022-04-20 23:17:28.138811]       TOKEN_ALPHA: 0.25
[2022-04-20 23:17:28.138826]       TOKEN_GAMMA: 2.0
[2022-04-20 23:17:28.138841]       TOKEN_LOSS_WEIGHT: 1.0
[2022-04-20 23:17:28.138854]       TYPE: MHA-B
[2022-04-20 23:17:28.138867]       USE_BACKBONE_SHALLOW_CONTRASTIVE_LOSS: False
[2022-04-20 23:17:28.138881]       USE_CLASSIFICATION_LOSS: False
[2022-04-20 23:17:28.138896]       USE_CONTRASTIVE_ALIGN_LOSS: False
[2022-04-20 23:17:28.138909]       USE_DOT_PRODUCT_TOKEN_LOSS: True
[2022-04-20 23:17:28.138923]       USE_FUSED_FEATURES_DOT_PRODUCT: True
[2022-04-20 23:17:28.138935]       USE_LAYER_SCALE: True
[2022-04-20 23:17:28.138949]       USE_SHALLOW_CONTRASTIVE_LOSS: False
[2022-04-20 23:17:28.138964]       USE_SHALLOW_ZERO_PADS: False
[2022-04-20 23:17:28.138977]       USE_TOKEN_LOSS: False
[2022-04-20 23:17:28.138990]     GROUPS: 1
[2022-04-20 23:17:28.139002]     LOG_SCALE: 0.0
[2022-04-20 23:17:28.139016]     NUM_CLASSES: 81
[2022-04-20 23:17:28.139030]     NUM_CONVS: 6
[2022-04-20 23:17:28.139044]     PRIOR_PROB: 0.01
[2022-04-20 23:17:28.139058]     SCORE_AGG: MEAN
[2022-04-20 23:17:28.139071]     SHALLOW_LOG_SCALE: 0.0
[2022-04-20 23:17:28.139085]     TOPK: 9
[2022-04-20 23:17:28.139099]     USE_CHECKPOINT: True
[2022-04-20 23:17:28.139112]     USE_DFCONV: True
[2022-04-20 23:17:28.139126]     USE_DYFUSE: True
[2022-04-20 23:17:28.139139]     USE_DYRELU: True
[2022-04-20 23:17:28.139153]     USE_GN: True
[2022-04-20 23:17:28.139166]     USE_NSYNCBN: False
[2022-04-20 23:17:28.139181]     USE_SYNCBN: False
[2022-04-20 23:17:28.139194]   EVO_NORM:
[2022-04-20 23:17:28.139209]     EPSILON: 1e-05
[2022-04-20 23:17:28.139225]     NUM_GROUPS: 8
[2022-04-20 23:17:28.139237]   FCOS:
[2022-04-20 23:17:28.139251]     CENTERNESS_ON_REG: False
[2022-04-20 23:17:28.139265]     CENTER_SAMPLING_RADIUS: 0.0
[2022-04-20 23:17:28.139277]     DETECTIONS_PER_IMG: 100
[2022-04-20 23:17:28.139292]     FPN_STRIDES: [8, 16, 32, 64, 128]
[2022-04-20 23:17:28.139305]     INFERENCE_TH: 0.05
[2022-04-20 23:17:28.139318]     INFERENCE_TH_TRAIN: 0.0
[2022-04-20 23:17:28.139331]     IOU_LOSS_TYPE: iou
[2022-04-20 23:17:28.139344]     NMS_TH: 0.6
[2022-04-20 23:17:28.139361]     NORM_REG_TARGETS: False
[2022-04-20 23:17:28.139374]     NUM_CLASSES: 81
[2022-04-20 23:17:28.139387]     NUM_CONVS: 4
[2022-04-20 23:17:28.139401]     POST_NMS_TOP_N_TRAIN: 1000
[2022-04-20 23:17:28.139413]     PRE_NMS_TOP_N: 1000
[2022-04-20 23:17:28.139427]     PRE_NMS_TOP_N_TRAIN: 3000
[2022-04-20 23:17:28.139441]     PRIOR_PROB: 0.01
[2022-04-20 23:17:28.139453]     USE_BN: False
[2022-04-20 23:17:28.139467]     USE_DFCONV: False
[2022-04-20 23:17:28.139480]     USE_GN: False
[2022-04-20 23:17:28.139493]     USE_GT_CENTER: False
[2022-04-20 23:17:28.139503]   FOCAL:
[2022-04-20 23:17:28.139516]     BBOX_REG_BETA: 0.11
[2022-04-20 23:17:28.139529]     BBOX_REG_WEIGHT: 4.0
[2022-04-20 23:17:28.139545]     BG_IOU_THRESHOLD: 0.4
[2022-04-20 23:17:28.139559]     FG_IOU_THRESHOLD: 0.5
[2022-04-20 23:17:28.139572]     LOSS_ALPHA: 0.25
[2022-04-20 23:17:28.139585]     LOSS_GAMMA: 2.0
[2022-04-20 23:17:28.139599]   FPN:
[2022-04-20 23:17:28.139612]     DROP_BLOCK: True
[2022-04-20 23:17:28.139624]     DROP_PROB: 0.3
[2022-04-20 23:17:28.139638]     DROP_SIZE: 3
[2022-04-20 23:17:28.139652]     FREEZE: False
[2022-04-20 23:17:28.139664]     RETURN_SWINT_FEATURE_BEFORE_FUSION: False
[2022-04-20 23:17:28.139678]     USE_DYHEAD: False
[2022-04-20 23:17:28.139690]     USE_DYRELU: False
[2022-04-20 23:17:28.139704]     USE_GN: False
[2022-04-20 23:17:28.139716]     USE_PAN: False
[2022-04-20 23:17:28.139730]     USE_RELU: False
[2022-04-20 23:17:28.139744]     USE_SPP: False
[2022-04-20 23:17:28.139757]   GROUP_NORM:
[2022-04-20 23:17:28.139771]     DIM_PER_GP: -1
[2022-04-20 23:17:28.139783]     EPSILON: 1e-05
[2022-04-20 23:17:28.139797]     NUM_GROUPS: 16
[2022-04-20 23:17:28.139809]   KEYPOINT_ON: False
[2022-04-20 23:17:28.139823]   LANGUAGE_BACKBONE:
[2022-04-20 23:17:28.139837]     BIDIRECTIONAL: True
[2022-04-20 23:17:28.139850]     CORPUS_PATH: 
[2022-04-20 23:17:28.139863]     DROPOUT_P: 0.2
[2022-04-20 23:17:28.139877]     FREEZE: False
[2022-04-20 23:17:28.139889]     HIDDEN_SIZE: 512
[2022-04-20 23:17:28.139902]     INPUT_DROPOUT_P: 0.5
[2022-04-20 23:17:28.139916]     LANG_DIM: 768
[2022-04-20 23:17:28.139928]     MASK_SPECIAL: False
[2022-04-20 23:17:28.139942]     MAX_QUERY_LEN: 256
[2022-04-20 23:17:28.139956]     MODEL_TYPE: bert-base-uncased
[2022-04-20 23:17:28.139968]     N_LAYERS: 1
[2022-04-20 23:17:28.139996]     PAD_MAX: True
[2022-04-20 23:17:28.140010]     RNN_TYPE: lstm
[2022-04-20 23:17:28.140023]     TOKENIZER_TYPE: bert-base-uncased
[2022-04-20 23:17:28.140037]     UNUSED_TOKEN: 106
[2022-04-20 23:17:28.140050]     USE_CHECKPOINT: False
[2022-04-20 23:17:28.140063]     VARIABLE_LENGTH: True
[2022-04-20 23:17:28.140076]     VOCAB_SIZE: 0
[2022-04-20 23:17:28.140089]     WEIGHT: 
[2022-04-20 23:17:28.140102]     WORD_EMBEDDING_SIZE: 512
[2022-04-20 23:17:28.140115]     WORD_VEC_SIZE: 512
[2022-04-20 23:17:28.140128]   LINEAR_PROB: False
[2022-04-20 23:17:28.140142]   MASK_ON: False
[2022-04-20 23:17:28.140156]   META_ARCHITECTURE: GeneralizedVLRCNN
[2022-04-20 23:17:28.140171]   MULTITASK:
[2022-04-20 23:17:28.140184]     
[2022-04-20 23:17:28.140198]   ONNX: False
[2022-04-20 23:17:28.140211]   PRETRAIN_NAME: 
[2022-04-20 23:17:28.140224]   RESNETS:
[2022-04-20 23:17:28.140238]     BACKBONE_OUT_CHANNELS: 1024
[2022-04-20 23:17:28.140251]     DEFORMABLE_GROUPS: 1
[2022-04-20 23:17:28.140265]     NUM_GROUPS: 1
[2022-04-20 23:17:28.140278]     RES2_OUT_CHANNELS: 256
[2022-04-20 23:17:28.140292]     RES5_DILATION: 1
[2022-04-20 23:17:28.140306]     REVISION: resnet_light
[2022-04-20 23:17:28.140321]     STAGE_WITH_DCN: (False, False, False, False)
[2022-04-20 23:17:28.140334]     STEM_FUNC: StemWithFixedBatchNorm
[2022-04-20 23:17:28.140360]     STEM_OUT_CHANNELS: 64
[2022-04-20 23:17:28.140374]     STRIDE_IN_1X1: True
[2022-04-20 23:17:28.140386]     TRANS_FUNC: BottleneckWithFixedBatchNorm
[2022-04-20 23:17:28.140400]     USE_AVG_DOWN: False
[2022-04-20 23:17:28.140414]     USE_STEM3X3: False
[2022-04-20 23:17:28.140427]     WIDTH_PER_GROUP: 64
[2022-04-20 23:17:28.140441]     WITH_MODULATED_DCN: False
[2022-04-20 23:17:28.140455]     WITH_SE: False
[2022-04-20 23:17:28.140467]   RETINANET:
[2022-04-20 23:17:28.140481]     DETECTIONS_PER_IMG: 100
[2022-04-20 23:17:28.140494]     INFERENCE_TH: 0.05
[2022-04-20 23:17:28.140507]     NMS_TH: 0.4
[2022-04-20 23:17:28.140521]     NUM_CLASSES: 81
[2022-04-20 23:17:28.140534]     NUM_CONVS: 4
[2022-04-20 23:17:28.140546]     PRE_NMS_TOP_N: 1000
[2022-04-20 23:17:28.140560]     PRIOR_PROB: 0.01
[2022-04-20 23:17:28.140583]   ROI_BOX_HEAD:
[2022-04-20 23:17:28.140598]     CONV_HEAD_DIM: 256
[2022-04-20 23:17:28.140612]     DILATION: 1
[2022-04-20 23:17:28.140625]     FEATURE_EXTRACTOR: ResNet50Conv5ROIFeatureExtractor
[2022-04-20 23:17:28.140639]     MLP_HEAD_DIM: 1024
[2022-04-20 23:17:28.140652]     NUM_CLASSES: 81
[2022-04-20 23:17:28.140665]     NUM_STACKED_CONVS: 4
[2022-04-20 23:17:28.140679]     POOLER_ALIGNED: False
[2022-04-20 23:17:28.140692]     POOLER_RESOLUTION: 14
[2022-04-20 23:17:28.140704]     POOLER_SAMPLING_RATIO: 0
[2022-04-20 23:17:28.140718]     POOLER_SCALES: (0.0625,)
[2022-04-20 23:17:28.140732]     PREDICTOR: FastRCNNPredictor
[2022-04-20 23:17:28.140745]     USE_GN: False
[2022-04-20 23:17:28.140756]   ROI_HEADS:
[2022-04-20 23:17:28.140770]     BATCH_SIZE_PER_IMAGE: 512
[2022-04-20 23:17:28.140783]     BBOX_REG_WEIGHTS: (10.0, 10.0, 5.0, 5.0)
[2022-04-20 23:17:28.140797]     BG_IOU_THRESHOLD: 0.5
[2022-04-20 23:17:28.140811]     DETECTIONS_PER_IMG: 100
[2022-04-20 23:17:28.140833]     FG_IOU_THRESHOLD: 0.5
[2022-04-20 23:17:28.140846]     NMS: 0.5
[2022-04-20 23:17:28.140860]     POSITIVE_FRACTION: 0.25
[2022-04-20 23:17:28.140872]     SCORE_THRESH: 0.05
[2022-04-20 23:17:28.140886]     USE_FPN: False
[2022-04-20 23:17:28.140898]   ROI_KEYPOINT_HEAD:
[2022-04-20 23:17:28.140917]     CONV_LAYERS: (512, 512, 512, 512, 512, 512, 512, 512)
[2022-04-20 23:17:28.140931]     FEATURE_EXTRACTOR: KeypointRCNNFeatureExtractor
[2022-04-20 23:17:28.140945]     KEYPOINT_NAME: ()
[2022-04-20 23:17:28.140961]     MLP_HEAD_DIM: 1024
[2022-04-20 23:17:28.140985]     NUM_CLASSES: 17
[2022-04-20 23:17:28.140995]     POOLER_RESOLUTION: 14
[2022-04-20 23:17:28.141005]     POOLER_SAMPLING_RATIO: 0
[2022-04-20 23:17:28.141015]     POOLER_SCALES: (0.0625,)
[2022-04-20 23:17:28.141031]     PREDICTOR: KeypointRCNNPredictor
[2022-04-20 23:17:28.141048]     RESOLUTION: 14
[2022-04-20 23:17:28.141066]     SHARE_BOX_FEATURE_EXTRACTOR: True
[2022-04-20 23:17:28.141079]   ROI_MASK_HEAD:
[2022-04-20 23:17:28.141093]     CONV_LAYERS: (256, 256, 256, 256)
[2022-04-20 23:17:28.141106]     DILATION: 1
[2022-04-20 23:17:28.141120]     FEATURE_EXTRACTOR: ResNet50Conv5ROIFeatureExtractor
[2022-04-20 23:17:28.141133]     HG_SCALE: 1
[2022-04-20 23:17:28.141150]     MLP_HEAD_DIM: 1024
[2022-04-20 23:17:28.141183]     POOLER_RESOLUTION: 14
[2022-04-20 23:17:28.141202]     POOLER_SAMPLING_RATIO: 0
[2022-04-20 23:17:28.141219]     POOLER_SCALES: (0.0625,)
[2022-04-20 23:17:28.141237]     POSTPROCESS_MASKS: False
[2022-04-20 23:17:28.141255]     POSTPROCESS_MASKS_THRESHOLD: 0.5
[2022-04-20 23:17:28.141272]     PREDICTOR: MaskRCNNC4Predictor
[2022-04-20 23:17:28.141288]     RESOLUTION: 14
[2022-04-20 23:17:28.141306]     SHARE_BOX_FEATURE_EXTRACTOR: True
[2022-04-20 23:17:28.141324]     USE_GN: False
[2022-04-20 23:17:28.141341]   RPN:
[2022-04-20 23:17:28.141360]     ANCHOR_SHIFT: (0.0, 0.0, 0.0, 0.0)
[2022-04-20 23:17:28.141390]     ANCHOR_SIZES: (64, 128, 256, 512, 1024)
[2022-04-20 23:17:28.141406]     ANCHOR_STRIDE: (8, 16, 32, 64, 128)
[2022-04-20 23:17:28.141424]     ASPECT_RATIOS: (1.0,)
[2022-04-20 23:17:28.141440]     BATCH_SIZE_PER_IMAGE: 256
[2022-04-20 23:17:28.141457]     BG_IOU_THRESHOLD: 0.3
[2022-04-20 23:17:28.141475]     FG_IOU_THRESHOLD: 0.7
[2022-04-20 23:17:28.141491]     FORCE_BOXES: False
[2022-04-20 23:17:28.141508]     FPN_POST_NMS_TOP_N_TEST: 2000
[2022-04-20 23:17:28.141525]     FPN_POST_NMS_TOP_N_TRAIN: 2000
[2022-04-20 23:17:28.141542]     FREEZE: False
[2022-04-20 23:17:28.141560]     MIN_SIZE: 0
[2022-04-20 23:17:28.141574]     NMS_THRESH: 0.7
[2022-04-20 23:17:28.141586]     OCTAVE: 2.0
[2022-04-20 23:17:28.141600]     POSITIVE_FRACTION: 0.5
[2022-04-20 23:17:28.141613]     POST_NMS_TOP_N_TEST: 1000
[2022-04-20 23:17:28.141627]     POST_NMS_TOP_N_TRAIN: 2000
[2022-04-20 23:17:28.141642]     PRE_NMS_TOP_N_TEST: 6000
[2022-04-20 23:17:28.141656]     PRE_NMS_TOP_N_TRAIN: 12000
[2022-04-20 23:17:28.141668]     RETURN_FUSED_FEATURES: False
[2022-04-20 23:17:28.141682]     RPN_HEAD: SingleConvRPNHead
[2022-04-20 23:17:28.141692]     SCALES_PER_OCTAVE: 1
[2022-04-20 23:17:28.141706]     STRADDLE_THRESH: 0
[2022-04-20 23:17:28.141718]     USE_FPN: True
[2022-04-20 23:17:28.141732]     USE_RELATIVE_SIZE: False
[2022-04-20 23:17:28.141744]   RPN_ARCHITECTURE: VLDYHEAD
[2022-04-20 23:17:28.141758]   RPN_ONLY: True
[2022-04-20 23:17:28.141770]   SPEC:
[2022-04-20 23:17:28.141784]     
[2022-04-20 23:17:28.141798]   SWINT:
[2022-04-20 23:17:28.141822]     APE: False
[2022-04-20 23:17:28.141836]     DEPTHS: (2, 2, 6, 2)
[2022-04-20 23:17:28.141850]     DROP_PATH_RATE: 0.2
[2022-04-20 23:17:28.141863]     EMBED_DIM: 96
[2022-04-20 23:17:28.141877]     LAYER_SCALE: 0
[2022-04-20 23:17:28.141891]     MLP_RATIO: 4
[2022-04-20 23:17:28.141904]     NUM_HEADS: (3, 6, 12, 24)
[2022-04-20 23:17:28.141918]     OUT_CHANNELS: (96, 192, 384, 768)
[2022-04-20 23:17:28.141930]     OUT_NORM: True
[2022-04-20 23:17:28.141944]     VERSION: v1
[2022-04-20 23:17:28.141957]     WINDOW_SIZE: 7
[2022-04-20 23:17:28.141971]   WEIGHT: swin_tiny_patch4_window7_224.pth
[2022-04-20 23:17:28.141984] OUTPUT_DIR: ./output
[2022-04-20 23:17:28.141998] PATHS_CATALOG: /ceph-jd/pub/jupyter/zhumuzhi/notebooks/GLIP/maskrcnn_benchmark/config/paths_catalog.py
[2022-04-20 23:17:28.142012] SEARCH:
[2022-04-20 23:17:28.142025]   CROSSOVER_NUM: 24
[2022-04-20 23:17:28.142038]   MAX_EPOCH: 20
[2022-04-20 23:17:28.142053]   MUTATION_NUM: 24
[2022-04-20 23:17:28.142066]   MUTATION_PROB: 0.1
[2022-04-20 23:17:28.142080]   POPULATION_NUM: 64
[2022-04-20 23:17:28.142093]   SELECT_NUM: 20
[2022-04-20 23:17:28.142106] SOLVER:
[2022-04-20 23:17:28.142119]   AUTO_TERMINATE_PATIENCE: -1
[2022-04-20 23:17:28.142133]   BACKBONE_BODY_LR_FACTOR: 1.0
[2022-04-20 23:17:28.142145]   BASE_LR: 0.0001
[2022-04-20 23:17:28.142169]   BIAS_LR_FACTOR: 2
[2022-04-20 23:17:28.142183]   CHECKPOINT_PERIOD: 2500
[2022-04-20 23:17:28.142197]   CHECKPOINT_PER_EPOCH: -1.0
[2022-04-20 23:17:28.142209]   CLIP_GRADIENTS:
[2022-04-20 23:17:28.142223]     CLIP_TYPE: full_model
[2022-04-20 23:17:28.142235]     CLIP_VALUE: 1.0
[2022-04-20 23:17:28.142249]     ENABLED: True
[2022-04-20 23:17:28.142265]     NORM_TYPE: 2.0
[2022-04-20 23:17:28.142281]   DATASET_LENGTH: -1
[2022-04-20 23:17:28.142295]   DISABLE_OUTPUT_DISTRIBUTED: False
[2022-04-20 23:17:28.142309]   FIND_UNUSED_PARAMETERS: False
[2022-04-20 23:17:28.142324]   GAMMA: 0.1
[2022-04-20 23:17:28.142337]   GRAD_CLIP: 0.0
[2022-04-20 23:17:28.142354]   IMS_PER_BATCH: 64
[2022-04-20 23:17:28.142369]   LANG_LR: 1e-05
[2022-04-20 23:17:28.142383]   MAX_EPOCH: 30
[2022-04-20 23:17:28.142396]   MAX_ITER: 40000
[2022-04-20 23:17:28.142419]   MAX_NEG_PER_BATCH: 0.1
[2022-04-20 23:17:28.142433]   MIN_LR: 1e-06
[2022-04-20 23:17:28.142449]   MODEL_EMA: 0.999
[2022-04-20 23:17:28.142462]   MOMENTUM: 0.9
[2022-04-20 23:17:28.142476]   MULTI_MAX_EPOCH: ()
[2022-04-20 23:17:28.142489]   MULTI_MAX_ITER: ()
[2022-04-20 23:17:28.142502]   OPTIMIZER: ADAMW
[2022-04-20 23:17:28.142515]   PROMPT_PROBING_LEVEL: -1.0
[2022-04-20 23:17:28.142528]   SEED: 0
[2022-04-20 23:17:28.142541]   STEPS: (0.67, 0.89)
[2022-04-20 23:17:28.142555]   STEP_PATIENCE: 5
[2022-04-20 23:17:28.142567]   TEST_WITH_INFERENCE: False
[2022-04-20 23:17:28.142581]   TUNING_HIGHLEVEL_OVERRIDE: None
[2022-04-20 23:17:28.142594]   USE_AMP: True
[2022-04-20 23:17:28.142611]   USE_AUTOSTEP: False
[2022-04-20 23:17:28.142625]   USE_COSINE: False
[2022-04-20 23:17:28.142639]   USE_EMA_FOR_MONITOR: False
[2022-04-20 23:17:28.142652]   WARMUP_FACTOR: 0.001
[2022-04-20 23:17:28.142666]   WARMUP_ITERS: 2000
[2022-04-20 23:17:28.142682]   WARMUP_METHOD: linear
[2022-04-20 23:17:28.142692]   WEIGHT_DECAY: 0.0001
[2022-04-20 23:17:28.142705]   WEIGHT_DECAY_BIAS: 0.0
[2022-04-20 23:17:28.142719]   WEIGHT_DECAY_NORM_FACTOR: 1.0
[2022-04-20 23:17:28.142732]   WEIGHT_DECAY_SCHEDULE: False
[2022-04-20 23:17:28.142755]   WEIGHT_DECAY_SCHEDULE_RATIO: 0.667
[2022-04-20 23:17:28.142769] TENSORBOARD_EXP: OUTPUT
[2022-04-20 23:17:28.142783] TEST:
[2022-04-20 23:17:28.142796]   CHUNKED_EVALUATION: -1
[2022-04-20 23:17:28.142806]   DURING_TRAINING: False
[2022-04-20 23:17:28.142819]   EVAL_TASK: detection
[2022-04-20 23:17:28.142831]   EXPECTED_RESULTS: []
[2022-04-20 23:17:28.142845]   EXPECTED_RESULTS_SIGMA_TOL: 4
[2022-04-20 23:17:28.142858]   FLIP: True
[2022-04-20 23:17:28.142872]   IMS_PER_BATCH: 1
[2022-04-20 23:17:28.142885]   MAX_SIZE: 2500
[2022-04-20 23:17:28.142897]   MDETR_STYLE_AGGREGATE_CLASS_NUM: -1
[2022-04-20 23:17:28.142911]   NUM_CLASSES: 81
[2022-04-20 23:17:28.142923]   PRE_NMS_TOP_N: 1000
[2022-04-20 23:17:28.142937]   RANGES: ((96, 10000), (96, 10000), (64, 10000), (64, 10000), (64, 10000), (0, 10000), (0, 10000), (0, 256), (0, 256), (0, 192), (0, 192), (0, 96))
[2022-04-20 23:17:28.142949]   SCALES: (400, 500, 600, 640, 700, 900, 1000, 1100, 1200, 1300, 1400, 1800)
[2022-04-20 23:17:28.142963]   SELECT_CLASSES: ()
[2022-04-20 23:17:28.142977]   SPECIAL_NMS: none
[2022-04-20 23:17:28.142989]   SUBSET: -1
[2022-04-20 23:17:28.143003]   TH: 0.6
[2022-04-20 23:17:28.143015]   USE_MULTISCALE: False
[2022-04-20 23:17:28.143029] local_rank: 0
[2022-04-20 23:17:28.143041] num_gpus: 1
[2022-04-20 23:17:28.143064] VISION BACKBONE USE GRADIENT CHECKPOINTING:  False

## **rpn.py** 

Module for RPN computation. Takes feature maps from the backbone and RPN proposals and losses. 

生成boxes以 loss

## **generalized_vl_rcnn.py**

定义了 class GeneralizedVLRCNN ，也就是整个模型的整体架构了

由以下三部分组成

backbone

  rpn 见 vldyhead.py

  heads: takes the features + the proposals from the RPN and computes

​    detections / masks from it

例如在detection的任务下，caption为'person. bicycle. car. motorcycle. airplane. bus. train. truck. boat. traffic light. fire hydrant. stop sign. parking meter. bench. bird. cat. dog. horse. sheep. cow. elephant. bear. zebra. giraffe. backpack. umbrella. handbag. tie. suitcase. frisbee. skis. snowboard. sports ball. kite. baseball bat. baseball glove. skateboard. surfboard. tennis racket. bottle. wine glass. cup. fork. knife. spoon. bowl. banana. apple. sandwich. orange. broccoli. carrot. hot dog. pizza. donut. cake. chair. couch. potted plant. bed. dining table. toilet. tv. laptop. mouse. remote. keyboard. cell phone. microwave. oven. toaster. sink. refrigerator. book. clock. vase. scissors. teddy bear. hair drier. toothbrush'即类别组成的句子



### language_backbone

ret = {
            "aggregate": aggregate,
            "embedded": embedded,
            "masks": mask,
            "hidden": encoded_layers[-1]
        }

### visual_backbone

分两种，一种是单独的SWINT 只负责image feature

一种是

SWINT_VL

the backbone only update the "hidden" field, currently,对languge feature的hidden layer更新。

[2022-04-23 12:00:32.903059] swin out torch.Size([3, 96, 200, 304])
[2022-04-23 12:00:32.906505] swin out torch.Size([3, 192, 100, 152])
[2022-04-23 12:00:32.913978] swin out torch.Size([3, 384, 50, 76])
[2022-04-23 12:00:32.915966] swin out torch.Size([3, 768, 25, 38])

输出也就是把不同层的feature提取出来。

## vldyhead.py





VLFuse 类

MHA-S 为单向只做T->I，MHA-B为双向

![image-20220423121933799](C:\Users\thinkpad\AppData\Roaming\Typora\typora-user-images\image-20220423121933799.png)

box_cls, box_regression, centerness, token_logits, \
        proj_tokens, contrastive_logits, dot_product_logits, mlm_logits, shallow_img_emb_feats, fused_visual_features = self.head(features,
                                                                        language_dict_features,
                                                                        embedding,
                                                                        swint_feature_c4
                                                                        )



print("box",box_cls[0].shape,box_regression[0].shape,centerness[0].shape)

box torch.Size([3, 80, 100, 152]) torch.Size([3, 4, 100, 152]) torch.Size([3, 1, 100, 152])

这个centerness的含义是什么，另外box_regression目前还有

接着还会产生anchors

 anchors = self.anchor_generator(images, features)

每张图会生成一些了的BoxLists

![image-20220426164723896](C:\Users\thinkpad\AppData\Roaming\Typora\typora-user-images\image-20220426164723896.png)



接下来就分为train和test

train会计算一系列Loss

loss_box_cls, loss_box_reg, loss_centerness, loss_token, loss_contrastive_align, loss_dot_product_token, loss_shallow_contrastive = self.loss_evaluator(
            box_cls, box_regression, centerness, targets, anchors,
            captions,
            positive_map,
            token_logits,
            proj_tokens,
            contrastive_logits,
            dot_product_logits,
            text_masks,
            shallow_img_emb_feats
        )



**test**

self.box_selector_test(box_regression, centerness, anchors,
                                       box_cls,
                                       token_logits,
                                       dot_product_logits,
                                       positive_map,
                                       )

多模态的自监督

## Dataset

 Cannot find coco/annotations/instances_val2017.json in ['./', './DATASET', './OUTPUT', './data', './MODEL']

/public_dataset/1/COCO/annotations

ln -s /public_dataset/1/COCO/annotations  /ceph-jd/pub/jupyter/zhumuzhi/notebooks/GLIP/DATASET/coco

ln -s /public_dataset/1/COCO/val2017 /ceph-jd/pub/jupyter/zhumuzhi/notebooks/GLIP/DATASET/coco

## RESULT

![image-20220421131959553](C:\Users\thinkpad\AppData\Roaming\Typora\typora-user-images\image-20220421131959553.png)

![image-20220426194857540](C:\Users\thinkpad\AppData\Roaming\Typora\typora-user-images\image-20220426194857540.png)
